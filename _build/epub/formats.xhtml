<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops">
  <head>
    <meta charset="utf-8" />
    <title>影像是什么</title>
    <link rel="stylesheet" href="_static/epub.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> 
  </head>
  <body>

    <div class="document">
      <div class="documentwrapper">
          <div class="body" role="main">
            
  <div class="section" id="id1">
<h1>影像是什么</h1>
<p>从真实世界中获取数字影像有很多方法，比如数码相机、扫描仪、CT或者磁共振成像。无论哪种方法，我们（人类）看到的是影像，而让数字设备来“看“的时候，则是在记录影像中的每一个点的数值。 <a class="footnote-reference brackets" href="#f1" id="id2">1</a></p>
<img alt="A matrix of the mirror of cameraman" class="align-center" src="_images/cameraman.png" />
<p>比如上面的影像，在标出的蓝框中你见到的只是一块灰色区域，但是计算机中识别为一个矩阵，该矩阵包含了所有像素点的强度值。如何获取并存储这些像素值由我们的需求而定，最终在计算机世界里所有影像都可以简化矩阵信息。当然，影像还有其他信息，下面我们即将介绍。</p>
<div class="section" id="id3">
<h2>影像元数据</h2>
<p>影像元数据是指影像中除了信息矩阵以外的一些参考数据。例如影像的长、宽、波段数、数据类型、存储方式、投影坐标、太阳高度角、获取时间、传感器信息等内容。使用 <a class="reference internal" href="gdal-utilities.xhtml#gdalinfo"><span class="std std-ref">gdalinfo文件信息工具</span></a> ，我们就可以看到影像的元数据信息：</p>
<div class="figure align-center">
<img alt="multiBands Image" src="_images/metaData.png" />
</div>
</div>
<div class="section" id="gdal">
<h2>GDAL中的影像</h2>
<p>GDAL中，影像也可以称为 <a class="reference internal" href="gdal-data-model.xhtml#dataset"><span class="std std-ref">数据集</span></a> ，大致分为两种类型，多波段影像和多数据集影像。 <a class="reference internal" href="gdal-data-model.xhtml#gdaldatamodel"><span class="std std-ref">GDAL数据模型</span></a> 中我们将详细介绍GDAL对影像数据如何解析和读写，这章中，我们只简单的分析一下两种数据的共性和区别。</p>
<div class="section" id="multibands">
<span id="id4"></span><h3>多波段数据</h3>
<p>多波段数据是我们比较熟悉的，例如tiff格式、jpg格式、png格式、img格式等，都是多个波段的数据。我们一般处理的也都是多波段的数据。</p>
<p>多波段的数据实际上可以看为一个二维的数组，在GDAL中就是包含了多个 <a class="reference internal" href="gdal-data-model.xhtml#rasterband"><span class="std std-ref">波段</span></a> 的一个 <a class="reference internal" href="gdal-data-model.xhtml#dataset"><span class="std std-ref">数据集</span></a> ，里面保存了影像的所有数据以及元数据。其中数据存在 <a class="reference internal" href="gdal-data-model.xhtml#rasterband"><span class="std std-ref">波段</span></a> 中，每个波段可以当作一维数组进行处理。如下图所示：</p>
<div class="figure align-center">
<img alt="multiBands Image" src="_images/multBands.png" />
</div>
</div>
<div class="section" id="multidatasets">
<span id="id5"></span><h3>多数据集数据</h3>
<p>这种数据遥感影像中也比较常见，例如hdf格式、he5格式、netcdf格式等。这些数据在GDAL中，与上文介绍的多波段数据不同，是包含了多个 <a class="reference internal" href="gdal-data-model.xhtml#dataset"><span class="std std-ref">数据集</span></a> 的 <a class="reference internal" href="gdal-data-model.xhtml#dataset"><span class="std std-ref">数据集</span></a> 。可以简单的理解为：一个多数据集数据包含了多个 <a class="reference internal" href="#multibands"><span class="std std-ref">多波段数据</span></a> ，当然，实际上，这些 <a class="reference internal" href="#multibands"><span class="std std-ref">多波段数据</span></a> 里大部分只有一个波段。如下图所示：</p>
<div class="figure align-center">
<img alt="multDataset Image" src="_images/multDataset.png" />
</div>
<p>一般我们会将多数据集数据转化为多波段的数据，方便处理。下面就是一个多数据集数据转换为多波段数据的函数，其中的部分内容我们将在后文中陆续展开讲解：</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">  GDALAllRegister,仅此一次</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">RegisterAll</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="n">GDALGetDriverByName</span><span class="p">(</span><span class="s">&quot;GTiff&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">GDALAllRegister</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">所有subset转成一个tif</span>
<span class="cm">  @param fileName    输入文件名</span>
<span class="cm">  @param outfile     输出文件名</span>
<span class="cm">  @param pBandIndex  所需输出的数据集，用数组表示，从1开始，例如[1,3,5]，传入NULL表示全部数据集</span>
<span class="cm">  @param pBandCount  所需输出数据集个数，如果pBandIndex设置为NULL，此参数无作用</span>
<span class="cm">  @return</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">subsets2tif</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fileName</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">outfile</span><span class="p">,</span> \
                 <span class="kt">int</span> <span class="o">*</span><span class="n">pBandIndex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pBandCount</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">outFileName</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="c1">//输出文件名</span>

  <span class="k">if</span><span class="p">(</span><span class="n">outfile</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">charNum</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
    <span class="n">charNum</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="n">outFileName</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">charNum</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">);</span>
    <span class="n">strcat</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s">&quot;.tif&quot;</span><span class="p">)</span> <span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">charNum</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">outfile</span><span class="p">);</span>
    <span class="n">outFileName</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">charNum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="n">outfile</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">RegisterAll</span><span class="p">();</span><span class="c1">//注册类型，打开影像必须加入此句</span>
  <span class="n">GDALDataset</span> <span class="o">*</span><span class="n">pDataSet</span> <span class="o">=</span> <span class="p">(</span><span class="n">GDALDataset</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDALOpen</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">GA_ReadOnly</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">pDataSet</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;不能打开该文件，请检查文件是否存在！&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//获取子数据集</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">papszSUBDATASETS</span> <span class="o">=</span> <span class="n">pDataSet</span><span class="o">-&gt;</span><span class="n">GetMetadata</span><span class="p">(</span><span class="s">&quot;SUBDATASETS&quot;</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">subdsNumber</span> <span class="o">=</span>  <span class="n">papszSUBDATASETS</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">CSLCount</span><span class="p">(</span><span class="n">papszSUBDATASETS</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">vSubDataSets</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">*</span><span class="p">[</span><span class="n">subdsNumber</span><span class="p">];</span> <span class="c1">//子数据集名称列表</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">vSubDataDesc</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="o">*</span><span class="p">[</span><span class="n">subdsNumber</span><span class="p">];</span> <span class="c1">//子数据集描述列表</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">papszMetadata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="c1">//如果没有子数据集，则其本身就是一个数据集</span>
  <span class="k">if</span><span class="p">(</span><span class="n">papszSUBDATASETS</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Metadata</span> <span class="o">=</span> <span class="n">GDALGetDriverShortName</span><span class="p">((</span><span class="n">GDALDriverH</span><span class="p">)</span><span class="n">pDataSet</span><span class="p">);</span>
    <span class="n">vSubDataSets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">Metadata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="n">vSubDataDesc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">Metadata</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">vSubDataSets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Metadata</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">vSubDataDesc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Metadata</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">iCount</span> <span class="o">=</span> <span class="n">CSLCount</span><span class="p">(</span><span class="n">papszSUBDATASETS</span><span class="p">);</span>  <span class="c1">//计算子数据集的个数</span>

    <span class="k">if</span><span class="p">(</span><span class="n">iCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">//没有子数据集,则返回</span>
      <span class="n">GDALClose</span><span class="p">((</span><span class="n">GDALDriverH</span><span class="p">)</span><span class="n">pDataSet</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//将子数据集压入列表</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">papszSUBDATASETS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kt">char</span> <span class="o">*</span><span class="n">setInfo</span> <span class="o">=</span> <span class="n">papszSUBDATASETS</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">setInfo</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">setInfo</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">setInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memmove</span><span class="p">(</span><span class="n">setInfo</span><span class="p">,</span> <span class="n">setInfo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">setInfo</span><span class="p">));</span> <span class="c1">//提取元数据中子数据集名称</span>
        <span class="n">vSubDataSets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">setInfo</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">vSubDataSets</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">setInfo</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kt">char</span> <span class="o">*</span><span class="n">descptn</span> <span class="o">=</span> <span class="n">papszSUBDATASETS</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="n">descptn</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">descptn</span><span class="p">,</span> <span class="s">&quot;=&quot;</span><span class="p">);</span>

      <span class="k">if</span><span class="p">(</span><span class="n">descptn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memmove</span><span class="p">(</span><span class="n">descptn</span><span class="p">,</span> <span class="n">descptn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">descptn</span><span class="p">));</span> <span class="c1">//提取元数据中子数据集描述</span>
        <span class="n">vSubDataDesc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">descptn</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">vSubDataDesc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">descptn</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="n">j</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span><span class="c1">//end for</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">;</span>
  <span class="n">GDALDriver</span> <span class="o">*</span><span class="n">poDriver</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pszFormat</span> <span class="o">=</span> <span class="s">&quot;GTiff&quot;</span><span class="p">;</span>
  <span class="n">poDriver</span> <span class="o">=</span> <span class="n">GetGDALDriverManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetDriverByName</span><span class="p">(</span><span class="n">pszFormat</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">poDriver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//将每个子数据集转为对应的tif假设所有数据集大小相同</span>
  <span class="kt">bool</span> <span class="n">init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">iBands</span> <span class="o">=</span> <span class="n">pBandIndex</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">?</span> <span class="nl">pBandCount</span> <span class="p">:</span> <span class="n">subdsNumber</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">realBandCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">subdsNumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">pBandIndex</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">bool</span> <span class="n">runNext</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

      <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">pBandCount</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">pBandIndex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">realBandCount</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">runNext</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span><span class="p">(</span><span class="n">runNext</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">realBandCount</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">dsName</span> <span class="o">=</span> <span class="n">vSubDataSets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">GDALDataset</span> <span class="o">*</span><span class="n">subDs</span> <span class="o">=</span> <span class="p">(</span><span class="n">GDALDataset</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDALOpen</span><span class="p">(</span><span class="n">dsName</span><span class="p">,</span> <span class="n">GA_ReadOnly</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">subDs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Width</span> <span class="o">=</span> <span class="n">subDs</span><span class="o">-&gt;</span><span class="n">GetRasterXSize</span><span class="p">();</span>
    <span class="n">Height</span> <span class="o">=</span> <span class="n">subDs</span><span class="o">-&gt;</span><span class="n">GetRasterYSize</span><span class="p">();</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">subData</span><span class="p">;</span>
    <span class="n">GDALRasterBand</span> <span class="o">*</span><span class="n">poBand</span> <span class="o">=</span> <span class="n">subDs</span><span class="o">-&gt;</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">GDALDataType</span> <span class="n">eBufType</span> <span class="o">=</span> <span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetRasterDataType</span><span class="p">();</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">eBufType</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">GDT_Byte</span><span class="p">:</span>
        <span class="n">subData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="nl">GDT_Int16</span><span class="p">:</span>
        <span class="n">subData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">short</span><span class="p">[</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="nl">GDT_Int32</span><span class="p">:</span>
        <span class="n">subData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="nl">GDT_Float32</span><span class="p">:</span>
        <span class="n">subData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="p">[</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="nl">GDT_Float64</span><span class="p">:</span>
        <span class="n">subData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="n">subData</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">double</span><span class="p">[</span><span class="n">Width</span> <span class="o">*</span> <span class="n">Height</span><span class="p">];</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">poBand</span><span class="o">-&gt;</span><span class="n">RasterIO</span><span class="p">(</span><span class="n">GF_Read</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">subData</span><span class="p">,</span>\
                     <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">eBufType</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">//写入影像</span>
    <span class="n">GDALDataset</span> <span class="o">*</span><span class="n">pDstDs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//创建影像</span>
      <span class="kt">char</span> <span class="o">**</span><span class="n">papszOptions</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="c1">//设置bsq或者 BIP bsq:BAND,bip:PIXEL</span>
      <span class="n">papszOptions</span> <span class="o">=</span> <span class="n">CSLSetNameValue</span><span class="p">(</span><span class="n">papszOptions</span><span class="p">,</span> <span class="s">&quot;INTERLEAVE&quot;</span><span class="p">,</span> <span class="s">&quot;BAND&quot;</span><span class="p">);</span>
      <span class="n">pDstDs</span> <span class="o">=</span> <span class="n">poDriver</span><span class="o">-&gt;</span><span class="n">Create</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> \
                                <span class="n">iBands</span><span class="p">,</span> <span class="n">eBufType</span><span class="p">,</span> <span class="n">papszOptions</span><span class="p">);</span>
      <span class="kt">double</span> <span class="n">geos</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
      <span class="n">subDs</span><span class="o">-&gt;</span><span class="n">GetGeoTransform</span><span class="p">(</span><span class="n">geos</span><span class="p">);</span><span class="c1">//变换参数</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">pszProjection</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">pszPrettyWkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="c1">//获取ds1坐标</span>
      <span class="n">OGRSpatialReferenceH</span>  <span class="n">hSRS</span><span class="p">;</span>

      <span class="k">if</span><span class="p">(</span><span class="n">GDALGetProjectionRef</span><span class="p">(</span><span class="n">subDs</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pszProjection</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDALGetProjectionRef</span><span class="p">(</span><span class="n">subDs</span><span class="p">);</span>
        <span class="n">hSRS</span> <span class="o">=</span> <span class="n">OSRNewSpatialReference</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">OSRImportFromWkt</span><span class="p">(</span><span class="n">hSRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pszProjection</span><span class="p">)</span> <span class="o">==</span> <span class="n">CE_None</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">OSRExportToPrettyWkt</span><span class="p">(</span><span class="n">hSRS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pszPrettyWkt</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
          <span class="n">pDstDs</span><span class="o">-&gt;</span><span class="n">SetProjection</span><span class="p">(</span><span class="n">pszPrettyWkt</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">//设置坐标</span>
      <span class="n">pDstDs</span><span class="o">-&gt;</span><span class="n">SetGeoTransform</span><span class="p">(</span><span class="n">geos</span><span class="p">);</span>
      <span class="n">CPLFree</span><span class="p">(</span><span class="n">pszPrettyWkt</span><span class="p">);</span>
      <span class="n">pDstDs</span><span class="o">-&gt;</span><span class="n">SetMetadata</span><span class="p">(</span><span class="n">subDs</span><span class="o">-&gt;</span><span class="n">GetMetadata</span><span class="p">());</span>
      <span class="n">pDstDs</span><span class="o">-&gt;</span><span class="n">FlushCache</span><span class="p">();</span>
      <span class="n">init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">//打开影像</span>
      <span class="n">pDstDs</span> <span class="o">=</span> <span class="p">(</span><span class="n">GDALDataset</span> <span class="o">*</span><span class="p">)</span> <span class="n">GDALOpen</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="n">GA_Update</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">GDALRasterBand</span> <span class="o">*</span><span class="n">poBandOut</span><span class="p">;</span>
    <span class="n">poBandOut</span> <span class="o">=</span> <span class="n">pDstDs</span><span class="o">-&gt;</span><span class="n">GetRasterBand</span><span class="p">(</span><span class="n">realBandCount</span><span class="p">);</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">SetScale</span><span class="p">(</span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetScale</span><span class="p">());</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">SetOffset</span><span class="p">(</span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetOffset</span><span class="p">());</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">SetUnitType</span><span class="p">(</span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetUnitType</span><span class="p">());</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">SetColorInterpretation</span><span class="p">(</span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetColorInterpretation</span><span class="p">());</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">SetDescription</span><span class="p">(</span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetDescription</span><span class="p">());</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">SetNoDataValue</span><span class="p">(</span><span class="n">poBand</span><span class="o">-&gt;</span><span class="n">GetNoDataValue</span><span class="p">());</span>
    <span class="c1">//GDT_Float32和 **OutputImg 类型要对应！</span>
    <span class="n">poBandOut</span><span class="o">-&gt;</span><span class="n">RasterIO</span><span class="p">(</span><span class="n">GF_Write</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> \
                        <span class="n">subData</span><span class="p">,</span> <span class="n">Width</span><span class="p">,</span> <span class="n">Height</span><span class="p">,</span> <span class="n">eBufType</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pDstDs</span><span class="o">-&gt;</span><span class="n">FlushCache</span><span class="p">();</span>
    <span class="c1">//关闭</span>
    <span class="n">GDALClose</span><span class="p">(</span><span class="n">subDs</span><span class="p">);</span>
    <span class="n">GDALClose</span><span class="p">(</span><span class="n">pDstDs</span><span class="p">);</span>
    <span class="k">delete</span><span class="p">[]</span> <span class="n">subData</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">GDALClose</span><span class="p">(</span><span class="n">pDataSet</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="n">papszMetadata</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="n">papszMetadata</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">subdsNumber</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span><span class="p">[]</span> <span class="n">vSubDataDesc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">delete</span><span class="p">[]</span> <span class="n">vSubDataSets</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">delete</span><span class="p">[]</span> <span class="n">vSubDataDesc</span><span class="p">;</span>
  <span class="n">vSubDataDesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">vSubDataSets</span><span class="p">;</span>
  <span class="n">vSubDataSets</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="k">delete</span><span class="p">[]</span> <span class="n">outFileName</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class="label" id="f1"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p><a class="reference external" href="http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/core/mat%20-%20the%20basic%20image%20container/mat%20-%20the%20basic%20image%20container.html#matthebasicimagecontainer">来自OpenCV文档</a><span class="link-target"> [http://www.opencv.org.cn/opencvdoc/2.3.2/html/doc/tutorials/core/mat%20-%20the%20basic%20image%20container/mat%20-%20the%20basic%20image%20container.html#matthebasicimagecontainer]</span></p>
</dd>
</dl>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
  </body>
</html>